<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Foglal√°sok</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7f8; margin:0; }
    .wrap { max-width: 1100px; margin:0 auto; padding:16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    h1 { margin:0 0 6px; font-size:20px; }
    .muted { color:#6b7280; font-size:13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hr { height:1px; background:#e5e7eb; margin:14px 0; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; background:#fff; }
    .radio { display:inline-flex; align-items:center; gap:6px; font-size:13px; }
    .radio input { transform: translateY(1px); }
    .select, .input, textarea { border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:13px; background:#fff; }
    textarea { width:100%; min-height:70px; resize:vertical; }
    .btn { border:0; border-radius:12px; padding:10px 12px; font-size:13px; cursor:pointer; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.gray { background:#9ca3af; }
    .btn.green { background:#16a34a; }
    .btn.blue { background:#2563eb; }
    .btn.red { background:#dc2626; }
    .btn.yellow { background:#f59e0b; color:#111827; }
    .btn.dark { background:#374151; }
    .btn.ghost { background:#fff; color:#111827; border:1px solid #d1d5db; }
    .order { border:1px solid #e5e7eb; border-radius:14px; padding:14px; margin:12px 0; background:#fff; }
    .orderTop { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .kv { font-size:13px; color:#111827; }
    .kv b { color:#111827; }
    .pre { white-space:pre-wrap; font-family: inherit; font-size:13px; }
    .statusBadge { display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px; font-size:12px; color:#fff; }
    .badge-gray { background:#9ca3af; }
    .badge-green { background:#16a34a; }
    .badge-blue { background:#2563eb; }
    .badge-red { background:#dc2626; }
    .badge-yellow { background:#f59e0b; color:#111827; }
    .badge-dark { background:#374151; }
    .panel { margin-top:12px; border:1px dashed #d1d5db; border-radius:14px; padding:12px; background:#fafafa; }
    .err { color:#b91c1c; font-size:13px; white-space:pre-wrap; }
    .ok { color:#166534; font-size:13px; white-space:pre-wrap; }
    .small { font-size:12px; color:#6b7280; }
    .right { margin-left:auto; }
    .w200 { min-width:200px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin ‚Äì Foglal√°sok</h1>
      <div class="muted">St√°tusz v√°lt√°s ‚Üí ment√©s a t√°bl√°ba + azonnali email k√ºld√©s (k√∂vetkez≈ë l√©p√©sben k√∂tj√ºk be a backend ment√©st).</div>

      <div class="hr"></div>

      <div class="row" style="align-items:flex-start;">
        <div class="pill"><b>Sz≈±r√©s:</b></div>

        <label class="radio"><input type="radio" name="flt" value="FELDOLGOZATLAN" checked> feldolgozatlan</label>
        <label class="radio"><input type="radio" name="flt" value="ALL"> √∂sszes</label>
        <label class="radio"><input type="radio" name="flt" value="AZONNAL_ATVEHETO"> azonnal √°tvehet≈ë</label>
        <label class="radio"><input type="radio" name="flt" value="RENDELHETO"> rendelhet≈ë</label>
        <label class="radio"><input type="radio" name="flt" value="TERMEKHIANY"> csak term√©khi√°ny</label>
        <label class="radio"><input type="radio" name="flt" value="TELJESITVE"> teljes√≠tve</label>
        <label class="radio"><input type="radio" name="flt" value="TOROLVE"> t√∂r√∂lve</label>

        <div class="right row">
          <span class="pill"><b>Rendez√©s:</b></span>
          <select id="sortKey" class="select">
            <option value="statusTime">Utolj√°ra m√≥dos√≠tva</option>
            <option value="orderId">Rendel√©ssz√°m</option>
          </select>
          <select id="sortDir" class="select">
            <option value="desc">cs√∂kken≈ë</option>
            <option value="asc">n√∂vekv≈ë</option>
          </select>
          <button class="btn ghost" id="refreshBtn" type="button">Friss√≠t√©s</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="adminApp">Bet√∂lt√©s‚Ä¶</div>
    </div>
  </div>

<script>
  const root = document.getElementById("adminApp");
  root.textContent = "Admin bet√∂lt√©se‚Ä¶";

  const ADMIN_TOKEN_KEY = "ADMIN_TOKEN_V1";

  function getAdminToken() {
    return localStorage.getItem(ADMIN_TOKEN_KEY) || "";
  }
  function setAdminToken(t) {
    localStorage.setItem(ADMIN_TOKEN_KEY, t);
  }
  function clearAdminToken() {
    localStorage.removeItem(ADMIN_TOKEN_KEY);
  }

  <script>
  function showLogin(message) {
    root.innerHTML = `
      <div style="max-width:420px;">
        <div style="font-weight:700; margin-bottom:8px;">Admin bel√©p√©s</div>
        <div style="font-size:13px; color:#6b7280; margin-bottom:10px;">
          K√©rlek add meg az admin jelsz√≥t.
        </div>

        <input
          id="adminPw"
          type="password"
          style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:12px;"
          placeholder="Jelsz√≥"
        />

        <button
          id="adminLoginBtn"
          style="margin-top:10px; padding:10px 14px; border-radius:12px; border:0; background:#111827; color:#fff; font-weight:700; cursor:pointer;"
        >
          Bel√©p√©s
        </button>

        <div id="adminLoginMsg" style="margin-top:10px; font-size:13px; color:#b91c1c; white-space:pre-wrap;"></div>
      </div>
    `;

    const msgEl = document.getElementById("adminLoginMsg");
    const pwEl = document.getElementById("adminPw");
    const btnEl = document.getElementById("adminLoginBtn");

    msgEl.textContent = message || "";

    function doLogin() {
      const pw = (pwEl.value || "").trim();
      if (!pw) {
        msgEl.textContent = "K√©rlek add meg a jelsz√≥t.";
        return;
      }

      msgEl.style.color = "#6b7280";
      msgEl.textContent = "Ellen≈ërz√©s‚Ä¶";
      btnEl.disabled = true;

      google.script.run
        .withSuccessHandler((res) => {
          btnEl.disabled = false;

          if (res && res.ok && res.token) {
            setAdminToken(res.token);
            bootstrapAdmin(); // ‚úÖ indulhat az admin
            return;
          }

          msgEl.style.color = "#b91c1c";
          msgEl.textContent = (res && res.message) ? res.message : "Hib√°s jelsz√≥.";
        })
        .withFailureHandler((err) => {
          btnEl.disabled = false;
          msgEl.style.color = "#b91c1c";
          msgEl.textContent = "Hiba: " + (err && err.message ? err.message : err);
        })
        .verifyAdminPassword_(pw);
    }

    btnEl.onclick = doLogin;

    // Enterre is l√©pjen be
    pwEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") doLogin();
    });

    // f√≥kusz a mez≈ëre
    pwEl.focus();
  }
</script>


  function bootstrapAdmin() {
    const token = getAdminToken();
    if (!token) {
      showLogin("");
      return;
    }

    // itt indul a te megl√©v≈ë admin logik√°d: loadOrders(), stb.
    loadOrders();
  }
  const refreshBtn = document.getElementById("refreshBtn");
  const sortKeyEl = document.getElementById("sortKey");
  const sortDirEl = document.getElementById("sortDir");

  let ALL_ORDERS = [];

  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function normStatus(s) {
    const x = String(s || "").trim().toUpperCase();
    if (x === "AZONNAL √ÅTVEHET≈ê" || x === "AZONNAL_ATVEHETO") return "AZONNAL_ATVEHETO";
    if (x === "NINCS K√âSZLETEN, DE RENDELHET≈ê" || x === "RENDELHETO") return "RENDELHETO";
    if (x === "TERM√âKHI√ÅNY" || x === "TERMEKHIANY") return "TERMEKHIANY";
    if (x === "TELJES√çTVE" || x === "TELJESITVE") return "TELJESITVE";
    if (x === "T√ñR√ñLVE" || x === "TOROLVE") return "TOROLVE";
    return "FELDOLGOZATLAN";
  }

  function statusLabel(code) {
    switch (code) {
      case "AZONNAL_ATVEHETO": return "AZONNAL √ÅTVEHET≈ê";
      case "RENDELHETO": return "NINCS K√âSZLETEN, DE RENDELHET≈ê";
      case "TERMEKHIANY": return "TERM√âKHI√ÅNY";
      case "TELJESITVE": return "TELJES√çTVE";
      case "TOROLVE": return "T√ñR√ñLVE";
      default: return "FELDOLGOZATLAN";
    }
  }

  function badgeClass(code) {
    switch (code) {
      case "AZONNAL_ATVEHETO": return "badge-green";
      case "RENDELHETO": return "badge-blue";
      case "TERMEKHIANY": return "badge-red";
      case "TELJESITVE": return "badge-yellow";
      case "TOROLVE": return "badge-dark";
      default: return "badge-gray";
    }
  }

  function fmtDate(x) {
    if (!x) return "";
    try {
      const d = (x instanceof Date) ? x : new Date(x);
      if (isNaN(d.getTime())) return String(x);
      return d.toLocaleString("hu-HU");
    } catch (e) {
      return String(x);
    }
  }

  function getSelectedFilter() {
    const el = document.querySelector('input[name="flt"]:checked');
    return el ? el.value : "FELDOLGOZATLAN";
  }

  function applyFilterSort() {
    const flt = getSelectedFilter();
    let list = (ALL_ORDERS || []).slice();

    // normaliz√°ljuk a status-t
    list.forEach(o => o._statusCode = normStatus(o.status));

    if (flt !== "ALL") {
      list = list.filter(o => o._statusCode === flt);
    }

    const key = sortKeyEl.value;
    const dir = sortDirEl.value;

    list.sort((a,b) => {
      let av, bv;
      if (key === "orderId") {
        av = String(a.orderId || "");
        bv = String(b.orderId || "");
      } else {
        av = new Date(a.statusTime || a.timestamp || 0).getTime();
        bv = new Date(b.statusTime || b.timestamp || 0).getTime();
      }

      if (av < bv) return (dir === "asc") ? -1 : 1;
      if (av > bv) return (dir === "asc") ? 1 : -1;
      return 0;
    });

    renderOrders(list);
  }

  function renderOrders(orders) {
    if (!Array.isArray(orders)) {
      root.className = "err";
      root.textContent = "HIBA: getOrdersForAdmin() nem t√∂mb√∂t adott vissza: " + String(orders);
      return;
    }
    if (orders.length === 0) {
      root.className = "";
      root.textContent = "Nincs foglal√°s a kiv√°lasztott sz≈±r≈ëre.";
      return;
    }

    root.className = "";
    root.innerHTML = orders.map(o => {
      const statusCode = o._statusCode || normStatus(o.status);
      const eta = o.etaDate ? esc(o.etaDate) : "";
      const etaUnknown = (String(o.etaUnknown).toUpperCase() === "TRUE");
      const lastMod = fmtDate(o.statusTime || "");

      return `
        <div class="order" data-order="${esc(o.orderId)}" data-row="${esc(o.rowNumber)}">
          <div class="orderTop">
            <div class="kv">
              <div><b>Rendel√©ssz√°m:</b> ${esc(o.orderId)}</div>
              <div><b>N√©v:</b> ${esc(o.name)}</div>
              <div><b>Email:</b> ${esc(o.email)}</div>
            </div>

            <div class="kv">
              <div><span class="statusBadge ${badgeClass(statusCode)}">${esc(statusLabel(statusCode))}</span></div>
              <div class="small" style="margin-top:8px;"><b>Utolj√°ra m√≥dos√≠tva:</b> ${esc(lastMod || "-")}</div>
              <div class="small" style="margin-top:4px;"><b>V√°rhat√≥ be√©rkez√©s:</b> ${
                etaUnknown ? "ismeretlen" : (eta ? eta : "-")
              }</div>
            </div>
          </div>

          <div style="margin-top:10px;" class="pre"><b>Term√©kek:</b>\n${esc(o.itemsText)}</div>

          <div class="row" style="margin-top:12px;">
            <button class="btn green" type="button" onclick="openPanel('${esc(o.orderId)}','AZONNAL_ATVEHETO')">AZONNAL √ÅTVEHET≈ê</button>
            <button class="btn blue" type="button" onclick="openPanel('${esc(o.orderId)}','RENDELHETO')">RENDELHET≈ê</button>
            <button class="btn red" type="button" onclick="openPanel('${esc(o.orderId)}','TERMEKHIANY')">TERM√âKHI√ÅNY</button>
            <button class="btn yellow" type="button" onclick="openPanel('${esc(o.orderId)}','TELJESITVE')">TELJES√çTVE</button>
            <button class="btn dark" type="button" onclick="openPanel('${esc(o.orderId)}','TOROLVE')">T√ñR√ñLVE</button>
          </div>

          <div class="panel hidden" id="panel-${esc(o.orderId)}"></div>
        </div>
      `;
    }).join("");
  }

  function closeAllPanels() {
    document.querySelectorAll(".panel").forEach(p => {
      p.classList.add("hidden");
      p.innerHTML = "";
    });
  }

  function openPanel(orderId, targetStatus) {
    closeAllPanels();

    const card = document.querySelector(`.order[data-order="${CSS.escape(orderId)}"]`);
    const panel = document.getElementById(`panel-${orderId}`);
    if (!card || !panel) return;

    const statusName = statusLabel(targetStatus);

    const needsEta = (targetStatus === "RENDELHETO" || targetStatus === "TERMEKHIANY");
    const needsCancelReason = (targetStatus === "TOROLVE");

    panel.classList.remove("hidden");
    panel.innerHTML = `
      <div class="row" style="justify-content:space-between;">
        <div><b>St√°tuszv√°lt√°s:</b> ${esc(statusName)}</div>
        <button class="btn ghost" type="button" onclick="closeAllPanels()">Bez√°r√°s</button>
      </div>

      <div style="margin-top:10px;">
        <div class="small"><b>Megjegyz√©s (opcion√°lis):</b> ez beker√ºl a v√°s√°rl√≥i emailbe is.</div>
        <textarea id="note-${esc(orderId)}" placeholder="Pl.: f√©lrerakva, √°tad√°skor szem√©lyi igazolv√°ny, stb. (nem k√∂telez≈ë)"></textarea>
      </div>

      ${needsEta ? `
        <div class="hr"></div>
        <div class="row">
          <div class="w200">
            <div class="small"><b>V√°rhat√≥ √©rkez√©s d√°tum</b> ${targetStatus==="RENDELHETO" ? "(k√∂telez≈ë)" : "(opcion√°lis / vagy ismeretlen)"}</div>
            <input class="input" type="date" id="eta-${esc(orderId)}" />
          </div>

          <label class="radio" style="margin-top:18px;">
            <input type="checkbox" id="etaU-${esc(orderId)}" />
            v√°rhat√≥ d√°tum ismeretlen
          </label>
        </div>

        <div class="hr"></div>

        <div class="row">
          <label class="radio">
            <input type="checkbox" id="subAvail-${esc(orderId)}" />
            helyettes√≠t≈ë k√©sz√≠tm√©ny azonnal √°tvehet≈ë
          </label>

          <label class="radio">
            <input type="checkbox" id="subOrder-${esc(orderId)}" />
            helyettes√≠t≈ë k√©sz√≠tm√©ny rendelhet≈ë
          </label>

          <div class="w200">
            <div class="small"><b>Helyettes√≠t≈ë v√°rhat√≥ √©rkez√©s</b> (csak ha ‚Äúrendelhet≈ë‚Äù be van pip√°lva)</div>
            <input class="input" type="date" id="subEta-${esc(orderId)}" disabled />
          </div>
        </div>
      ` : ""}

      ${needsCancelReason ? `
        <div class="hr"></div>
        <div class="small"><b>T√∂rl√©s indokl√°sa (opcion√°lis):</b> ez is beker√ºl a v√°s√°rl√≥i emailbe.</div>
        <textarea id="cancelReason-${esc(orderId)}" placeholder="Pl.: nem el√©rhet≈ë recept, hib√°s adat, v√°s√°rl√≥ k√©rte, stb. (nem k√∂telez≈ë)"></textarea>
      ` : ""}

      <div class="hr"></div>

      <label class="radio">
        <input type="checkbox" id="confirm-${esc(orderId)}" />
        Biztosan √°t akarom tenni <b>${esc(orderId)}</b> rendel√©st <b>${esc(statusName)}</b> st√°tuszba (email k√ºld√©ssel)
      </label>

      <div class="row" style="margin-top:10px;">
        <button class="btn ${targetStatus==="AZONNAL_ATVEHETO"?"green":targetStatus==="RENDELHETO"?"blue":targetStatus==="TERMEKHIANY"?"red":targetStatus==="TELJESITVE"?"yellow":"dark"}"
          type="button" onclick="submitStatus('${esc(orderId)}','${esc(targetStatus)}')">
          Ment√©s + Email k√ºld√©se
        </button>
        <div id="msg-${esc(orderId)}" class="small"></div>
      </div>
    `;

    // dinamikus UX: ha etaUnknown be van pip√°lva, tiltjuk a d√°tumot
    if (needsEta) {
      const eta = document.getElementById(`eta-${orderId}`);
      const etaU = document.getElementById(`etaU-${orderId}`);
      const subOrder = document.getElementById(`subOrder-${orderId}`);
      const subEta = document.getElementById(`subEta-${orderId}`);

      const syncEta = () => {
        const u = !!etaU.checked;
        eta.disabled = u;
        if (u) eta.value = "";
      };
      etaU.addEventListener("change", syncEta);
      syncEta();

      const syncSub = () => {
        const on = !!subOrder.checked;
        subEta.disabled = !on;
        if (!on) subEta.value = "";
      };
      subOrder.addEventListener("change", syncSub);
      syncSub();
    }

    panel.scrollIntoView({ behavior:"smooth", block:"start" });
  }

 function submitStatus(orderId, targetStatus) {
  const msg = document.getElementById(`msg-${orderId}`);
  msg.className = "small";
  msg.textContent = "";

  // ‚úÖ DUPLA EMAIL ELLEN: ha nem v√°ltozik a st√°tusz, k√©rdezz√ºnk r√° k√ºl√∂n
  const current = (Array.isArray(ALL_ORDERS) ? ALL_ORDERS : []).find(
    o => String(o.orderId) === String(orderId)
  );
  const currentStatus = current ? String(current.status || "") : "";

  let forceEmail = false;
  if (currentStatus && currentStatus === String(targetStatus)) {
    const ok = window.confirm(
      `A st√°tusz nem v√°ltozik (most is: ${currentStatus}).\n\n` +
      `Biztosan szeretn√©l √≠gy is emailt k√ºldeni a v√°s√°rl√≥nak?`
    );
    if (!ok) {
      msg.className = "small";
      msg.textContent = "Nem k√ºldt√ºnk emailt (st√°tusz nem v√°ltozott).";
      return;
    }
    forceEmail = true;
  }

  const confirmEl = document.getElementById(`confirm-${orderId}`);
  if (!confirmEl || !confirmEl.checked) {
    msg.className = "err";
    msg.textContent = "K√©rlek pip√°ld be a meger≈ës√≠t√©st.";
    return;
  }

  const noteEl = document.getElementById(`note-${orderId}`);
  const note = noteEl ? noteEl.value.trim() : "";

  let etaDate = "";
  let etaUnknown = false;

  let substituteAvailable = false;
  let substituteOrderable = false;
  let substituteEtaDate = "";

  let cancelReason = "";

  const needsEta = (targetStatus === "RENDELHETO" || targetStatus === "TERMEKHIANY");
  if (needsEta) {
    const etaEl = document.getElementById(`eta-${orderId}`);
    const etaUEl = document.getElementById(`etaU-${orderId}`);

    etaUnknown = !!(etaUEl && etaUEl.checked);
    etaDate = etaEl ? String(etaEl.value || "") : "";

    if (targetStatus === "RENDELHETO") {
      // rendelhet≈ë: ETA k√∂telez≈ë (nem lehet ismeretlen)
      if (etaUnknown) {
        msg.className = "err";
        msg.textContent = "RENDELHET≈ê st√°tuszn√°l a v√°rhat√≥ d√°tum k√∂telez≈ë (nem lehet ismeretlen).";
        return;
      }
      if (!etaDate) {
        msg.className = "err";
        msg.textContent = "RENDELHET≈ê st√°tuszn√°l add meg a v√°rhat√≥ √©rkez√©s d√°tum√°t.";
        return;
      }
    }

    const subAvailEl = document.getElementById(`subAvail-${orderId}`);
    const subOrderEl = document.getElementById(`subOrder-${orderId}`);
    const subEtaEl = document.getElementById(`subEta-${orderId}`);

    substituteAvailable = !!(subAvailEl && subAvailEl.checked);
    substituteOrderable = !!(subOrderEl && subOrderEl.checked);
    substituteEtaDate = subEtaEl ? String(subEtaEl.value || "") : "";

    if (substituteOrderable && !substituteEtaDate) {
      msg.className = "err";
      msg.textContent = "Ha a ‚Äúhelyettes√≠t≈ë k√©sz√≠tm√©ny rendelhet≈ë‚Äù be van pip√°lva, k√∂telez≈ë a helyettes√≠t≈ë v√°rhat√≥ d√°tum.";
      return;
    }
  }

  if (targetStatus === "TOROLVE") {
    const cr = document.getElementById(`cancelReason-${orderId}`);
    cancelReason = cr ? cr.value.trim() : "";
  }

  const payload = {
    orderId: orderId,
    status: targetStatus,
    note: note,
    etaDate: etaDate,
    etaUnknown: etaUnknown,
    substituteAvailable: substituteAvailable,
    substituteOrderable: substituteOrderable,
    substituteEtaDate: substituteEtaDate,
    cancelReason: cancelReason,
    forceEmail: forceEmail // ‚úÖ EZ HI√ÅNYZOTT
  };

  msg.textContent = "Ment√©s folyamatban‚Ä¶";

  payload.adminToken = getAdminToken();

google.script.run
  .withSuccessHandler((res) => {
  // 1) NO_CHANGE = k√©rdezz r√°
  if (res && res.code === "NO_CHANGE") {
    const ok = confirm(res.message + "\n\nK√ºldj√ºnk √≠gy is emailt?");
    if (!ok) return;

    payload.forceSend = true;
payload.adminToken = getAdminToken();

    google.script.run
      .withSuccessHandler((res2) => {
        if (res2 && res2.ok) {
          msg.className = "ok";
          msg.textContent = "Email elk√ºldve (st√°tusz nem v√°ltozott).";
          loadOrders();
        } else {
          msg.className = "err";
          msg.textContent = (res2 && res2.message) ? res2.message : "Nem siker√ºlt.";
        }
      })
      .withFailureHandler((err2) => {
        msg.className = "err";
        msg.textContent = "Hiba: " + (err2 && err2.message ? err2.message : err2);
      })
      .updateOrderStatusAdmin(payload);

    return;
  }

  // 2) norm√°l siker
  if (res && res.ok) {
    msg.className = "ok";
    msg.textContent = "Mentve. Email elk√ºldve.";
    loadOrders();
    return;
  }

  // 3) norm√°l ‚Äúnem ok‚Äù
  msg.className = "err";
  msg.textContent = (res && res.message) ? res.message : "Nem siker√ºlt menteni.";
})


}
  function loadOrders() {
    root.className = "";
    root.textContent = "Foglal√°sok bet√∂lt√©se‚Ä¶";

    const payload = { adminToken: getAdminToken() };
payload.adminToken = getAdminToken();

    google.script.run
  .withSuccessHandler((orders) => {
    ALL_ORDERS = Array.isArray(orders) ? orders : [];
    applyFilterSort();
  })
  .withFailureHandler((err) => {
    const msg = (err && err.message) ? err.message : String(err);

    // ha token gond, dobd vissza loginra
    if (msg.toLowerCase().includes("token") || msg.toLowerCase().includes("jogosulatlan")) {
      clearAdminToken();
      showLogin(msg);
      return;
    }

    root.className = "err";
    root.textContent = "Hiba: " + msg;
  })
  .getOrdersForAdmin(getAdminToken());  // ‚úÖ EZ A L√âNYEG


  // events
  document.querySelectorAll('input[name="flt"]').forEach(r => r.addEventListener("change", applyFilterSort));
  sortKeyEl.addEventListener("change", applyFilterSort);
  sortDirEl.addEventListener("change", applyFilterSort);
  refreshBtn.addEventListener("click", loadOrders);

  // init
  loadOrders();
  function bootstrapAdmin() {
  const token = getAdminToken();
  if (!token) {
    showLogin();
    return;
  }
  loadOrders();
}

// üëá EZ A LEGALJ√ÅN
bootstrapAdmin();
</script>
</body>
</html>
