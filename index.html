<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gyógyszer foglalás</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #f6f7f8; }
    .wrap { max-width: 860px; margin: 0 auto; padding: 18px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .muted { color: #6b7280; font-size: 14px; margin: 6px 0 14px; }
    .topline { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap: wrap; }
    .pharm { font-size: 14px; color:#374151; }
    a { color: #0f766e; }
    .warn { background: #fff7ed; border: 1px solid #fed7aa; color:#9a3412; padding: 10px 12px; border-radius: 12px; font-size: 14px; margin: 12px 0 16px; }
    .sectionTitle { font-size: 16px; margin: 18px 0 10px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .field { flex: 1 1 240px; }
    label { display:block; font-size: 13px; color:#374151; margin: 8px 0 6px; }
    input[type="text"], input[type="email"], input[type="number"], select, textarea {
      width: 100%; box-sizing: border-box; border: 1px solid #d1d5db; border-radius: 12px; padding: 10px 12px; font-size: 14px; outline: none;
    }
    textarea { min-height: 70px; resize: vertical; }
    input:focus, select:focus, textarea:focus { border-color:#0f766e; box-shadow: 0 0 0 3px rgba(15,118,110,0.12); }
    .medBlock { border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px; margin: 12px 0; }
    .medHeader { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .medHeader strong { font-size: 14px; }
    .btnRow { display:flex; gap:10px; flex-wrap: wrap; margin-top: 14px; }
    button {
      border: 0; border-radius: 12px; padding: 10px 14px; font-size: 14px; cursor:pointer;
      background:#0f766e; color:#fff;
    }
    button.secondary { background:#111827; }
    button.ghost { background:#fff; color:#0f766e; border:1px solid #0f766e; }
    button.danger { background:#dc2626; }
    button:disabled { opacity: 0.6; cursor:not-allowed; }
    .hr { height:1px; background:#e5e7eb; margin: 18px 0; }
    .center { text-align:center; }
    .tiny { font-size: 12px; color:#6b7280; margin-top: 6px; }
    .ok { color:#166534; }
    .err { color:#b91c1c; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topline">
        <div>
          <h1>Gyógyszer foglalás</h1>
          <div class="pharm">
            <strong>Szent György Gyógyszertár</strong><br>
            8060 Mór, Köztársaság tér 1.<br>
            06 22 407 036
          </div>
        </div>
        <div class="center">
          <a href="https://gyogyszertarmor.hu" target="_blank">← Vissza a honlapra</a>
        </div>
      </div>

      <div class="warn">
        Vényköteles gyógyszer kizárólag érvényes orvosi vény ellenében váltható ki.
      </div>

      <!-- FOGALALÁS -->
      <div id="bookingContainer">
        <div class="sectionTitle"><strong>Készítmények</strong></div>
        <div id="medicinesContainer"></div>

        <div class="btnRow">
          <button type="button" class="ghost" onclick="addMedicineBlock()">➕ További készítmény hozzáadása</button>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle"><strong>Az Ön adatai</strong></div>
        <div class="row">
          <div class="field">
            <label for="userName">Név</label>
            <input id="userName" type="text" autocomplete="name" />
          </div>
          <div class="field">
            <label for="userEmail">Email</label>
            <input id="userEmail" type="email" autocomplete="email" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <label style="display:flex; gap:10px; align-items:flex-start;">
            <input type="checkbox" id="gdprCheck" />
            <span>
              Hozzájárulok ahhoz, hogy a Szent György Gyógyszertár a megadott személyes adataimat kezelje.
              <span class="tiny"><a href="<?= getAppUrl_() ?>?page=adatkezeles" target="_blank">Adatkezelési tájékoztató</a></span>
            </span>
          </label>
        </div>

        <!-- Honeypot -->
        <input id="website" type="text" class="hidden" tabindex="-1" autocomplete="off" />

        <div class="btnRow">
          <button type="button" class="secondary" onclick="submitBooking()">Foglalás leadása</button>
        </div>

        <p id="bookingResult" class="tiny"></p>
      </div>

      <div class="hr"></div>

      <!-- TÖRLÉS (csak linkről jövőknek) -->
      <div id="cancelContainer" style="display:none; text-align:center; margin-top: 10px;">
        <h3 style="margin: 6px 0 10px;">Foglalás törlése</h3>

        <p style="max-width:520px; margin:0 auto 12px; color:#374151; font-size:14px;">
          Ha törölni szeretnéd a foglalásod, add meg az email címedet. A <strong>rendelésszám</strong> automatikusan kitöltődik a link alapján.
        </p>

        <div style="max-width:420px; margin:0 auto;">
          <label for="cancelOrderId"><strong>Rendelésszám</strong></label>
          <input type="text" id="cancelOrderId" readonly style="text-align:center;" />

          <label for="cancelEmail"><strong>Email</strong></label>
          <input type="email" id="cancelEmail" style="text-align:center;" />

          <label style="display:inline-block; text-align:left; margin-top:10px;">
            <input type="checkbox" id="cancelConfirm" />
            Biztosan törölni szeretném a foglalást
          </label>

          <div class="btnRow" style="justify-content:center;">
            <button type="button" class="danger" onclick="requestCancel()">Foglalás törlése</button>
          </div>

          <p id="cancelResult" class="tiny"></p>
        </div>
      </div>
    </div>
  </div>

  <datalist id="medNames"></datalist>

  <script>
    let formStartTime = Date.now();

    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    function getQueryParam(name) {
  // Biztos módszer: URLSearchParams + fallback
  try {
    const params = new URLSearchParams(window.location.search || "");
    const v = params.get(name);
    if (v) return v;
  } catch (e) {}

  // Fallback: kézi parse
  const qs = (window.location.search || "").replace(/^\?/, "");
  if (!qs) return null;
  const parts = qs.split("&");
  for (const p of parts) {
    const [k, v] = p.split("=");
    if (decodeURIComponent(k || "") === name) return decodeURIComponent(v || "");
  }
  return null;
}

function initCancelUI() {
  const orderId = ("<?= orderIdFromServer ?>" || "").trim();
  if (!orderId) return;

  const cancelContainer = document.getElementById("cancelContainer");
  const cancelOrderId = document.getElementById("cancelOrderId");
  const booking = document.getElementById("bookingContainer");

  if (!cancelContainer || !cancelOrderId) return;

  cancelContainer.style.setProperty("display", "block", "important");
  cancelOrderId.value = orderId;

  if (booking) booking.style.display = "none";

  cancelContainer.scrollIntoView({ behavior: "smooth", block: "start" });
}

window.addEventListener("load", initCancelUI);

    function addMedicineBlock() {
      const container = document.getElementById("medicinesContainer");
      const idx = container.children.length + 1;

      const block = document.createElement("div");
      block.className = "medBlock";
      block.innerHTML = `
        <div class="medHeader">
          <strong>Készítmény #${idx}</strong>
          <button type="button" class="ghost" onclick="removeMedicineBlock(this)">Eltávolítás</button>
        </div>

        <div class="row">
          <div class="field">
            <label>Gyógyszer neve</label>
            <input type="text" class="medName" list="medNames" placeholder="Kezdj el gépelni..." />
            <div class="tiny">Tipp: 3-4 betű után várj egy pillanatot.</div>
          </div>

          <div class="field">
            <label>Kiszerelés</label>
            <select class="medPack">
              <option value="">Válassz kiszerelést…</option>
            </select>
          </div>

          <div class="field" style="flex: 0 1 160px;">
            <label>Mennyiség</label>
            <input type="number" class="medQty" min="1" value="1" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Megjegyzés (opcionális)</label>
            <textarea class="medCustom" placeholder="Írd ide a készítmény nevét, amennyiben a legördülő listában nem találod. Illetve, ha injekciót foglalsz és nem egy egész doboz van a recepten, hanem valamennyi ampulla, kérlek írd ide: ampulla."></textarea>
          </div>
        </div>
      `;

      container.appendChild(block);

      const nameInput = block.querySelector(".medName");
      const packSelect = block.querySelector(".medPack");

      let searchTimer = null;
      nameInput.addEventListener("input", () => {
        const q = nameInput.value.trim();
        packSelect.innerHTML = '<option value="">Válassz kiszerelést…</option>';
        packSelect.dataset.variations = "";

        if (q.length < 2) return;

        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
          google.script.run
  .withSuccessHandler((names) => {
    const dl = document.getElementById("medNames");
    dl.innerHTML = "";
    (names || []).forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      dl.appendChild(opt);
    });
  })
  .withFailureHandler((err) => {
    console.log("Keresési hiba:", err);
    return;
    // opcionálisan: mutassunk 1 rövid üzenetet
    // alert("Keresési hiba: " + (err && err.message ? err.message : err));
  })
  .getUniqueMedicines(q);
        }, 250);
      });

      nameInput.addEventListener("change", () => {
        const medName = nameInput.value.trim();
        packSelect.innerHTML = '<option value="">Betöltés…</option>';
        google.script.run
          .withSuccessHandler((variations) => {
            packSelect.innerHTML = '<option value="">Válassz kiszerelést…</option>';
            const vars = variations || [];
            vars.forEach(v => {
              const opt = document.createElement("option");
              opt.value = v.kiszereles;
              opt.textContent = `${v.kiszereles} — ${v.hatoanyag} — ${v.kiadhatosag}`;
              opt.dataset.hatoanyag = v.hatoanyag || "";
              opt.dataset.status = v.kiadhatosag || "";
              packSelect.appendChild(opt);
            });
          })
          .withFailureHandler(() => {
            packSelect.innerHTML = '<option value="">Nem sikerült betölteni</option>';
          })
          .getDetails(medName);
      });
    }

    function removeMedicineBlock(btn) {
      const block = btn.closest(".medBlock");
      if (block) block.remove();

      // újraszámozás
      const container = document.getElementById("medicinesContainer");
      Array.from(container.children).forEach((b, i) => {
        const strong = b.querySelector(".medHeader strong");
        if (strong) strong.textContent = `Készítmény #${i + 1}`;
      });
    }

    function submitBooking() {
      const resultEl = document.getElementById("bookingResult");
      resultEl.className = "tiny";
      resultEl.textContent = "";

      const userName = document.getElementById("userName").value.trim();
      const userEmail = document.getElementById("userEmail").value.trim();
      const gdprOk = document.getElementById("gdprCheck").checked;

      if (!userName || !userEmail) {
        resultEl.classList.add("err");
        resultEl.textContent = "Kérlek add meg a neved és az email címed.";
        return;
      }
      if (!gdprOk) {
        resultEl.classList.add("err");
        resultEl.textContent = "A foglaláshoz el kell fogadnod az adatkezelést.";
        return;
      }

      const blocks = Array.from(document.querySelectorAll(".medBlock"));
      const medicines = [];

      for (const b of blocks) {
        const name = b.querySelector(".medName").value.trim();
        const packSel = b.querySelector(".medPack");
        const pack = packSel.value;
        const qty = parseInt(b.querySelector(".medQty").value, 10) || 1;
        const custom = b.querySelector(".medCustom").value.trim();

        if (!name) continue;
        if (!pack) {
          resultEl.classList.add("err");
          resultEl.textContent = "Kérlek válassz kiszerelést minden megadott készítményhez.";
          return;
        }

        const selected = packSel.options[packSel.selectedIndex];
        const hatoanyag = selected ? (selected.dataset.hatoanyag || "") : "";
        const status = selected ? (selected.dataset.status || "") : "";

        medicines.push({
          name: name,
          pack: pack,
          quantity: qty,
          custom: custom,
          hatoanyag: hatoanyag,
          status: status
        });
      }

      if (medicines.length === 0) {
        resultEl.classList.add("err");
        resultEl.textContent = "Kérlek adj hozzá legalább 1 készítményt.";
        return;
      }

      const payload = {
        userName: userName,
        userEmail: userEmail,
        medicines: medicines,
        honeypot: document.getElementById("website").value,
        formTime: Date.now() - formStartTime
      };

      resultEl.textContent = "Foglalás küldése…";

      google.script.run
        .withSuccessHandler((res) => {
          if (res && res.ok) {
            resultEl.classList.add("ok");
resultEl.innerHTML = `
  <div style="margin-top:12px; padding:14px; border:1px solid #86efac; background:#ecfdf5; border-radius:12px;">
    <strong style="font-size:16px; color:#166534;">
      Foglalását rögzítettük ✅
    </strong>
    <p style="margin:8px 0 0; font-size:14px;">
      <strong>Fontos:</strong> a foglalás még <strong>nem minősül megerősített rendelésnek</strong>.<br>
      Hamarosan visszajelzünk az Ön email címére.
    </p>
    <p style="margin:8px 0 0; font-size:13px;">
      <strong>Rendelésszám:</strong> ${res.orderId}
    </p>
  </div>
`;
          } else {
            resultEl.classList.add("err");
            resultEl.textContent = "Nem sikerült a foglalás.";
          }
        })
        .withFailureHandler((err) => {
          resultEl.classList.add("err");
          resultEl.textContent = "Hiba: " + (err && err.message ? err.message : err);
        })
        .processBooking(payload);
    }

    function requestCancel() {
      const orderId = (document.getElementById("cancelOrderId").value || "").trim();
      const email = (document.getElementById("cancelEmail").value || "").trim();
      const confirm = document.getElementById("cancelConfirm").checked;
      const result = document.getElementById("cancelResult");

      result.className = "tiny";
      result.textContent = "";

      if (!orderId) {
        result.classList.add("err");
        result.textContent = "Hiányzik a rendelésszám. Kérlek az emailben lévő linket használd.";
        return;
      }
      if (!email) {
        result.classList.add("err");
        result.textContent = "Kérlek add meg az email címet.";
        return;
      }
      if (!confirm) {
        result.classList.add("err");
        result.textContent = "Kérlek erősítsd meg a törlést.";
        return;
      }

      result.textContent = "Törlés folyamatban…";

      google.script.run
        .withSuccessHandler((res) => {
          if (res && res.ok) {
            result.classList.add("ok");
            result.textContent = res.message || "A foglalás törölve lett.";
          } else {
            result.classList.add("err");
            result.textContent = (res && res.message) ? res.message : "Nem sikerült a törlés.";
          }
        })
        .withFailureHandler((err) => {
          result.classList.add("err");
          result.textContent = "Hiba: " + (err && err.message ? err.message : err);
        })
        .cancelBooking({ orderId: orderId, email: email });
    }

    // indulás
    addMedicineBlock();
  </script>
</body>
</html>
